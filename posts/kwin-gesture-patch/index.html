<!doctype html><html lang=en><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"><link rel=monetization href=https://ilp.gatehub.net/669637781/eur><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Binary Patching KWin for 3-Finger Overview Gesture","author":{"@type":"Person","name":"Hugues Morisset","url":"https://blog.izissise.net/about"},"datePublished":"2024-03-09"}</script><title>Binary Patching KWin for 3-Finger Overview Gesture</title><meta property="og:title" content="Binary Patching KWin for 3-Finger Overview Gesture"><script defer src=/js/codecopy.js></script><script defer src=/js/ofuscate.js></script><script data-goatcounter=https://izissise.goatcounter.com/count async src=/js/count.js></script><noscript><img style=display:none src="https://izissise.goatcounter.com//count?p=/posts/kwin-gesture-patch/&t=Binary Patching KWin for 3-Finger Overview Gesture"></noscript><link rel=alternate type=application/atom+xml title href=/atom.xml><link rel=stylesheet media=screen href=/main.css><div class=content><header><nav><a href=/posts>/posts</a>
<a href=/about>/about</a>
<a href=/atom.xml>/rss</a>
|
<button id=theme type=reset title="switch theme">ðŸŒ“</button>
<script src=/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Binary Patching KWin for 3-Finger Overview Gesture</div><div class=meta><span>Posted on <time datetime=2024-03-09>2024-03-09</time></span>
<span class=readingtime>2 minutes read</span></div></div><section class=body><p>TLDR: <a href=/posts/kwin-gesture-patch/#patching>Go to patching</a><h1 id=plasma-6><a class=zola-anchor href=#plasma-6 aria-label="Anchor link for: plasma-6">Plasma 6</a></h1><p>I recently updated to <a rel="noopener external" target=_blank href=https://neon.kde.org/>Kde Plasma 6</a>, and it's great except for one minor annoyance: the overview effect is triggered on the touchpad with a 4-finger swipe, and I'd prefer to trigger it with a 3-finger swipe instead.<p>Problem is, the value is <a rel="noopener external" target=_blank href=https://invent.kde.org/plasma/kwin/-/blob/master/src/plugins/overview/overvieweffect.cpp#L36>hardcoded in the C++ code</a><p>There is an <a rel="noopener external" target=_blank href="https://bugs.kde.org/show_bug.cgi?id=402857">issue about making it configurable</a> but without someone assigned to it. If you want to help implement it, you can <a rel="noopener external" target=_blank href=https://community.kde.org/Get_Involved>get involved</a><p>Today, I want an easy win, and it seems easy enough to patch the binary, so let's try.<h1 id=analysis><a class=zola-anchor href=#analysis aria-label="Anchor link for: analysis">Analysis</a></h1><p>Using <code>objdump -D /usr/bin/kwin_wayland | grep -i touchpad</code> we can find that the method <code>addTouchpadSwipeGesture</code>
is indeed in the <code>kwin_wayland</code> binary with the mangled name <code>_ZN4KWin22EffectTogglableGesture23addTouchpadSwipeGestureENS_14SwipeDirectionEj</code>.<p>We find exactly 3 calls to it, corresponding to the source code.<p>We want to keep the hex representation of the instructions that make up the call, specifically the hex of the 3 <code>mov</code> instructions before the <code>call</code>.<p>With:<pre class="giallo z-code"><code data-lang=asm><span class=giallo-l><span class="z-entity z-name">   d7b58:</span><span class=z-constant>       48 89</span><span> ef                </span><span class=z-keyword>mov</span><span>    %</span><span class=z-constant>rbp</span><span>,%</span><span class=z-constant>rdi</span></span>
<span class=giallo-l><span class="z-entity z-name">   d7b5b:</span><span>       ba </span><span class=z-constant>04 00 00 00</span><span class=z-keyword>          mov</span><span>    $0x4,%</span><span class=z-constant>edx</span></span>
<span class=giallo-l><span class="z-entity z-name">   d7b60:</span><span>       be </span><span class=z-constant>03 00 00 00</span><span class=z-keyword>          mov</span><span>    $0x3,%</span><span class=z-constant>esi</span></span>
<span class=giallo-l><span class="z-entity z-name">   d7b65:</span><span>       e8 </span><span class=z-constant>06</span><span class="z-storage z-type"> dd</span><span> f7 ff          </span><span class=z-keyword>call</span><span class=z-constant>   55870</span><span> &lt;_ZN4KWin22EffectTogglableGesture23addTouchpadSwipeGestureENS_14SwipeDirectionEj@plt&gt;</span></span></code></pre><p>we want <code>4889efba04000000be03000000e8</code><p>There are 2 fingerprints for the 3 calls<p><code>4889efba04000000be03000000e8</code>
and
<code>4889efba04000000be01000000e8</code><p>To enable a 3-finger gesture, we'll replace the second parameter <code>4</code> with <code>3</code> in the hex:
<code>4889efba</code><strong><code>03</code></strong><code>000000be03000000e8</code>
<code>4889efba</code><strong><code>03</code></strong><code>000000be01000000e8</code><p>For peace of mind, we can check that it doesn't match anything else<pre class="giallo z-code"><code data-lang=shellscript><span class=giallo-l><span class="z-entity z-name">$</span><span class=z-string> xxd</span><span class=z-constant> -p -c 0</span><span class=z-string> /usr/bin/kwin_wayland</span><span class=z-keyword> |</span><span class="z-entity z-name"> tr</span><span class=z-constant> -d</span><span class="z-punctuation z-definition z-string z-string"> &#39;[:space:]&#39;</span><span class=z-keyword> |</span><span class="z-entity z-name"> grep</span><span class=z-constant> -Eo</span><span class="z-punctuation z-definition z-string z-string"> &#39;4889efba04000000be0[3,1]000000e8&#39;</span></span>
<span class=giallo-l><span class="z-entity z-name">4889efba04000000be03000000e8</span></span>
<span class=giallo-l><span class="z-entity z-name">4889efba04000000be03000000e8</span></span>
<span class=giallo-l><span class="z-entity z-name">4889efba04000000be01000000e8</span></span></code></pre><p>We got 3 entries corresponding to the 3 calls so we're good!<h1 id=patching><a class=zola-anchor href=#patching aria-label="Anchor link for: patching">Patching</a></h1><p>Now that we have our fingerprints, we can patch the binary. To have a 3-finger gesture instead of 4, we can replace <code>mov $0x4,%edx</code> with <code>mov $0x3,%edx</code> using sed and xxd. Here's the process:<pre class="giallo z-code"><code data-lang=shellscript><span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># backup original</span></span>
<span class=giallo-l><span class="z-entity z-name">sudo</span><span class=z-string> cp</span><span class=z-constant> -a</span><span class=z-string> /usr/bin/kwin_wayland /usr/bin/kwin_wayland.bak</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># patch ba04 to ba03</span></span>
<span class=giallo-l><span class="z-entity z-name">xxd</span><span class=z-constant> -p -c 0</span><span class=z-string> /usr/bin/kwin_wayland</span><span class=z-keyword> |</span><span class="z-entity z-name"> tr</span><span class=z-constant> -d</span><span class="z-punctuation z-definition z-string z-string"> &#39;[:space:]&#39;</span><span class=z-keyword> |</span><span class="z-entity z-name"> sed</span><span class="z-punctuation z-definition z-string z-string"> &#39;s|4889efba04000000be0\(.\)000000e8|4889efba03000000be0\1000000e8|g&#39;</span><span class=z-keyword> |</span><span class="z-entity z-name"> xxd</span><span class=z-constant> -r -p</span><span class=z-keyword> &gt;</span><span class=z-string> kwin_wayland_patched</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># replace binary</span></span>
<span class=giallo-l><span class="z-entity z-name">sudo</span><span class=z-string> mv kwin_wayland_patched /usr/bin/kwin_wayland</span><span> &amp;&amp;</span><span class="z-entity z-name"> sudo</span><span class=z-string> chmod</span><span class=z-constant> 755</span><span class=z-string> /usr/bin/kwin_wayland</span><span> &amp;&amp;</span><span class="z-entity z-name"> sudo</span><span class=z-string> chown root:root /usr/bin/kwin_wayland</span></span></code></pre><p>Edit Ubuntu 24.04:<pre class="giallo z-code"><code data-lang=shellscript><span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># backup original</span></span>
<span class=giallo-l><span class="z-entity z-name">sudo</span><span class=z-string> cp</span><span class=z-constant> -a</span><span class=z-string> /usr/bin/kwin_wayland /usr/bin/kwin_wayland.bak</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># patch ba04 to ba03</span></span>
<span class=giallo-l><span class="z-entity z-name">xxd</span><span class=z-constant> -p -c 0</span><span class=z-string> /usr/bin/kwin_wayland</span><span class=z-keyword> |</span><span class="z-entity z-name"> tr</span><span class=z-constant> -d</span><span class="z-punctuation z-definition z-string z-string"> &#39;[:space:]&#39;</span><span class=z-keyword> |</span><span class="z-entity z-name"> sed</span><span class="z-punctuation z-definition z-string z-string"> &#39;s|4c89e7ba04000000be0\(.\)000000e8|4c89e7ba03000000be0\1000000e8|g&#39;</span><span class=z-keyword> |</span><span class="z-entity z-name"> xxd</span><span class=z-constant> -r -p</span><span class=z-keyword> &gt;</span><span class=z-string> kwin_wayland_patched</span></span>
<span class=giallo-l><span class="z-punctuation z-definition z-comment z-comment"># replace binary</span></span>
<span class=giallo-l><span class="z-entity z-name">sudo</span><span class=z-string> mv kwin_wayland_patched /usr/bin/kwin_wayland</span><span> &amp;&amp;</span><span class="z-entity z-name"> sudo</span><span class=z-string> chmod</span><span class=z-constant> 755</span><span class=z-string> /usr/bin/kwin_wayland</span><span> &amp;&amp;</span><span class="z-entity z-name"> sudo</span><span class=z-string> chown root:root /usr/bin/kwin_wayland</span></span></code></pre><p>Reboot and enjoy!</section></article></main></div><footer><hr><nav><a rel=me href=/about>Hugues</a> |
<a rel=atom href=/atom.xml class="rss icon" title=rss></a><a rel=me href=https://github.com/izissise class="github icon" title=github></a><a rel=me href=https://stackoverflow.com/users/2838914/izissise class="stack icon" title=stackoverflow></a><a rel=me href=https://links.izissise.net/ class="shaarli icon" title=shaarli></a><a rel=me href=https://www.linkedin.com/in/huguesmorisset/ class="linkedin icon" title=linkedin></a><a rel=me href="=MWM2IDZ1cDN0ATMwEDMyEjYxEmM5QDMwIWNmFjYxQDMkFDNyYDNxATMygDNwEDOwEWM3MjM1QDM" class="m-protected matrix icon" title=matrix></a><a rel=me href="==wYwQWMiBjZ0QDMhJjM1QDM2AjMzIWM0ADZxQjM2QTMwYGN2ADZwITMiFTYyEDN2AzYwgDN3ATNxQDMhJjM1QDM" class="m-protected mail icon" title=email></a>| &#169; 2026