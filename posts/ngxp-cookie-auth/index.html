<!doctype html><html lang=en><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"><link rel=monetization href=https://ilp.gatehub.net/669637781/eur><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx Explorer - Cookie Authentication","author":{"@type":"Person","name":"Hugues Morisset","url":"https://blog.izissise.net/about"},"datePublished":"2024-11-04"}</script><title>Nginx Explorer - Cookie Authentication</title><meta property="og:title" content="Nginx Explorer - Cookie Authentication"><script defer src=/js/codecopy.js></script><script defer src=/js/ofuscate.js></script><script data-goatcounter=https://izissise.goatcounter.com/count async src=/js/count.js></script><noscript><img style=display:none src="https://izissise.goatcounter.com//count?p=/posts/ngxp-cookie-auth/&t=Nginx Explorer - Cookie Authentication"></noscript><link rel=alternate type=application/atom+xml title href=/atom.xml><link rel=stylesheet media=screen href=/main.css><div class=content><header><nav><a href=/posts>/posts</a>
<a href=/about>/about</a>
<a href=/atom.xml>/rss</a>
|
<button id=theme type=reset title="switch theme">ðŸŒ“</button>
<script src=/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Nginx Explorer - Cookie Authentication</div><div class=meta><span>Posted on <time datetime=2024-11-04>2024-11-04</time></span>
<span class=readingtime>3 minutes read</span></div></div><section class=body><p><a href=/posts/ngxp-listing/>Previously</a>, we configured <code>nginx</code> to list directories and files in html.
Now, letâ€™s add authentication to restrict access to specific directories and files.<h1 id=basic-authentication><a class=zola-anchor href=#basic-authentication aria-label="Anchor link for: basic-authentication">Basic authentication</a></h1><p>The simplest web authentication method is <a rel="noopener external" target=_blank href=https://en.wikipedia.org/wiki/Basic_access_authentication>basic authentication</a>.
It requires an <code>Authorization</code> header in each request.
However, browsers donâ€™t support setting a header on requests without javascript,
and with javascript, thereâ€™s no sane way to stream file downloads to the browserâ€™s download manager.<p>So, once the initial basic auth login is validated, we'll use cookies, which browsers automatically include for each request on the same site.<p>Letâ€™s start by creating a <code>login</code> endpoint with <a rel="noopener external" target=_blank href=http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html>nginx basic auth</a> to verify the user/password pair and set a cookie for users with valid credentials.<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class="z-storage z-type">server</span><span> {</span></span>
<span class=giallo-l><span>    ...</span></span>
<span class=giallo-l><span class="z-storage z-type">    location</span><span class="z-entity z-name"> @login_success </span><span>{</span></span>
<span class=giallo-l><span class=z-keyword>        add_header</span><span> Set-Cookie </span><span class=z-string>&quot;ngxp=???; max-age=15552000; path=/; SameSite=Lax; Secure; HttpOnly&quot;</span><span>;</span></span>
<span class=giallo-l><span class=z-keyword>        return</span><span class=z-constant> 200</span><span class=z-string> &quot;login success&quot;</span><span>;</span></span>
<span class=giallo-l><span>    }</span></span>
<span class=giallo-l><span class="z-storage z-type z-keyword">    location ^~</span><span class="z-string z-regexp"> /___ngxp/login </span><span>{</span></span>
<span class=giallo-l><span class=z-keyword>        auth_basic</span><span class=z-string> &quot;Login&quot;</span><span>;</span></span>
<span class=giallo-l><span class=z-keyword>        auth_delay</span><span class=z-constant> 1s</span><span>;</span></span>
<span class=giallo-l><span class=z-keyword>        auth_basic_user_file</span><span> /opt/ngxp/basic.htpasswd;</span></span>
<span class=giallo-l><span class=z-keyword>        try_files</span><span> _ @login_success;</span></span>
<span class=giallo-l><span>    }</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>To create entries in <code>basic.htpasswd</code>, we use openssl<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>:<pre class="giallo z-code"><code data-lang=shellscript><span class=giallo-l><span class=z-support>printf</span><span class="z-punctuation z-definition z-string z-string"> &#39;%s:%s\n&#39; &quot;</span><span class="z-variable z-other">$user</span><span class="z-punctuation z-definition z-string z-string">&quot; &quot;$(</span><span class="z-entity z-name">openssl</span><span class=z-string> passwd</span><span class=z-constant> -5</span><span class="z-punctuation z-definition z-string"> &quot;</span><span class="z-variable z-other">$password</span><span class="z-punctuation z-definition z-string z-string">&quot;)&quot;</span><span class=z-keyword> &gt;&gt;</span><span class=z-string> basic.htpasswd</span></span></code></pre><p>We can successfully login using basic auth on the <code>login</code> endpoint!<h1 id=cookie-set><a class=zola-anchor href=#cookie-set aria-label="Anchor link for: cookie-set">Cookie set</a></h1><p>To check that the user is authorized to access the current path and
that cookies cannot be hand-crafted,
we need to store the following in the cookie:<ul><li>username<li>a secret, so a cookie cannot be hand crafted<li>the paths base the user has access to</ul><p>Using <a rel="noopener external" target=_blank href=http://nginx.org/en/docs/http/ngx_http_map_module.html>nginx map module</a>, weâ€™ll store this information for each user:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span class=z-comment>#     input     output</span></span>
<span class=giallo-l><span class="z-storage z-type">map</span><span> $</span><span class=z-variable>username</span><span class="z-variable z-other"> $user_cookie {</span></span>
<span class=giallo-l><span class=z-constant>    default</span><span class=z-string> &quot;&quot;</span><span>;</span></span>
<span class=giallo-l><span>    admin   admin|d31d6b17bbc4df3ccb78d99db085e9d347b3e042e65d5878|/;</span></span>
<span class=giallo-l><span>    alice   alice|2406b10bfd4c356394a647d5657bde937124f602198f20f3|/alicefiles;</span></span>
<span class=giallo-l><span>    bob     bob|3f02f891206f421739edb7565d746a493653c4dfb01b6042|/bob|/photos;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>Later, with map's <code>include</code> directive we can store it into a file.<p>In <code>@login_success</code>, assign the <code>ngxp</code> cookie value.
When <code>$username</code> is set with the basic auth username (<code>$remote_user</code>), <code>$user_cookie</code> is set with the mapped value.<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span class="z-storage z-type">    location</span><span class="z-entity z-name"> @login_success </span><span>{</span></span>
<span class=giallo-l><span class=z-keyword>        set</span><span class="z-variable z-other"> $username $remote_user;</span><span class=z-comment> # $remote_user is the basic_auth user in Authorization http header</span></span>
<span class=giallo-l><span class=z-keyword>        add_header</span><span> Set-Cookie </span><span class=z-string>&quot;ngxp=$</span><span class="z-variable z-other">user_cookie</span><span class=z-string>; max-age=15552000; path=/; SameSite=Lax; Secure; HttpOnly&quot;</span><span>;</span></span>
<span class=giallo-l><span class=z-keyword>        return</span><span class=z-constant> 200</span><span class=z-string> &quot;login success&quot;</span><span>;</span></span>
<span class=giallo-l><span>    }</span></span></code></pre><h1 id=cookie-check><a class=zola-anchor href=#cookie-check aria-label="Anchor link for: cookie-check">Cookie check</a></h1><p>The only thing left to do is to check if our cookie is valid and authorized for the current uri when listing files.
<code>$cookie_ngxp</code> contains the http request provided cookie (from the browser).<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span class=z-comment># get username from http request&#39;s cookie</span></span>
<span class=giallo-l><span class="z-storage z-type">map</span><span> $</span><span class=z-variable>cookie_ngxp</span><span class="z-variable z-other"> $username {</span></span>
<span class=giallo-l><span class=z-keyword>    ~</span><span class="z-string z-regexp">^(?&lt;var&gt;[^\|]+)\|.* $</span><span>var;</span></span>
<span class=giallo-l><span class=z-constant>    default</span><span class=z-string>              &quot;&quot;</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>It's an untrusted user input, so we should check that
it matches exactly with the one set for the username.<p>Since we just set <code>$username</code>, <code>$user_cookie</code> has the trusted cookie value for the user (if it exists),
so we check that both variables are equal:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span class=z-keyword>map</span><span class="z-variable z-other"> ${cookie_ngxp}</span><span class=z-keyword>\\${user_cookie} $user_cookie_equal </span><span>{</span></span>
<span class=giallo-l><span>    ~^([^\x5c]+)\x5c\1$ 1; </span><span class=z-comment># if $user_cookie == $cookie_ngxp  (\ == \x5c)</span></span>
<span class=giallo-l><span class=z-keyword>    default</span><span class=z-constant>             0</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>By modifying <code>location /</code> slightly, we can already restrict listing and download to requests with a valid cookie:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class="z-storage z-type">server</span><span> {</span></span>
<span class=giallo-l><span>    ...</span></span>
<span class=giallo-l><span class="z-storage z-type">    location</span><span class="z-entity z-name"> / </span><span>{</span></span>
<span class=giallo-l><span class=z-keyword>        if</span><span class="z-variable z-other"> ($user_cookie_equal</span><span class=z-keyword> = </span><span>0) {</span><span class=z-keyword> return</span><span class=z-constant> 401</span><span>; }</span></span>
<span class=giallo-l><span>        ...</span></span>
<span class=giallo-l><span>    }</span></span>
<span class=giallo-l><span>}</span></span></code></pre><h1 id=cookie-access><a class=zola-anchor href=#cookie-access aria-label="Anchor link for: cookie-access">Cookie access</a></h1><p>We also want to have per path access rights, we first extract the path from <code>$user_cookie</code>:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class="z-storage z-type">map</span><span> $</span><span class=z-variable>user_cookie</span><span class="z-variable z-other"> $user_cookie_accesses {</span></span>
<span class=giallo-l><span class=z-keyword>    ~</span><span class="z-string z-regexp">^([^\|]+)\|([^\|]+)\|(?&lt;var&gt;.+)$</span><span class="z-variable z-other"> $var;</span></span>
<span class=giallo-l><span class=z-constant>    default</span><span class=z-string>                           &quot;&quot;</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>Using a map with two variable as input, we can check if <a rel="noopener external" target=_blank href=http://nginx.org/en/docs/http/ngx_http_core_module.html#var_uri><code>$uri</code></a>
starts with the extracted path<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class=z-keyword>map</span><span class="z-variable z-other"> ${user_cookie_accesses}</span><span class=z-keyword>\\${uri} $uri_access { # request uri </span><span>access</span></span>
<span class=giallo-l><span>    ~^(|[^\x5c]*\|)([^\|]+)(\x5c|\|[^\x5c]*\x5c)\2((?&lt;=\/)|$|\/).*$ 1; </span><span class=z-comment># if $user_cookie_accesses contains $uri (\ - \x5c)</span></span>
<span class=giallo-l><span class=z-keyword>    default</span><span class=z-constant>                                                         0</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><h1 id=cookie-authorized><a class=zola-anchor href=#cookie-authorized aria-label="Anchor link for: cookie-authorized">Cookie authorized</a></h1><p>Finally, ensure that both the cookie and path-based access rights are validated:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class=z-keyword>map</span><span class="z-variable z-other"> ${user_cookie_equal}${uri_access} $user_authorized {</span></span>
<span class=giallo-l><span class=z-keyword>    11</span><span class=z-constant>          1</span><span>;</span><span class=z-comment> # everything ok, authorize</span></span>
<span class=giallo-l><span class=z-keyword>    default</span><span class=z-constant>     0</span><span>;</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>In the file listing endpoint, check <code>$user_authorized</code>:<pre class="giallo z-code"><code data-lang=nginx data-name=default.conf><span class=giallo-l><span>...</span></span>
<span class=giallo-l><span class="z-storage z-type">server</span><span> {</span></span>
<span class=giallo-l><span>    ...</span></span>
<span class=giallo-l><span class="z-storage z-type">    location</span><span class="z-entity z-name"> / </span><span>{</span></span>
<span class=giallo-l><span class=z-keyword>        if</span><span class="z-variable z-other"> ($user_authorized</span><span class=z-keyword> = </span><span>0) {</span><span class=z-keyword> return</span><span class=z-constant> 401</span><span>; }</span></span>
<span class=giallo-l><span>        ...</span></span>
<span class=giallo-l><span>    }</span></span>
<span class=giallo-l><span>}</span></span></code></pre><p>We now have per user and path accesses!<p><a href=/posts/ngxp-upload/>Next time we'll see how to upload files</a>.<section class=footnotes><ol class=footnotes-list><li id=fn-1><p>You can also use htpasswd. <a href=#fr-1-1>â†©</a></ol></section></section></article></main></div><footer><hr><nav><a rel=me href=/about>Hugues</a> |
<a rel=atom href=/atom.xml class="rss icon" title=rss></a><a rel=me href=https://github.com/izissise class="github icon" title=github></a><a rel=me href=https://stackoverflow.com/users/2838914/izissise class="stack icon" title=stackoverflow></a><a rel=me href=https://links.izissise.net/ class="shaarli icon" title=shaarli></a><a rel=me href=https://www.linkedin.com/in/huguesmorisset/ class="linkedin icon" title=linkedin></a><a rel=me href="=MWM2IDZ1cDN0ATMwEDMyEjYxEmM5QDMwIWNmFjYxQDMkFDNyYDNxATMygDNwEDOwEWM3MjM1QDM" class="m-protected matrix icon" title=matrix></a><a rel=me href="==wYwQWMiBjZ0QDMhJjM1QDM2AjMzIWM0ADZxQjM2QTMwYGN2ADZwITMiFTYyEDN2AzYwgDN3ATNxQDMhJjM1QDM" class="m-protected mail icon" title=email></a>| &#169; 2026