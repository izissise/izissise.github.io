<!doctype html><html lang=en><html class="dark light"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"><link rel=monetization href=https://ilp.gatehub.net/669637781/eur><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Nginx Explorer - Cookie Authentication","author":{"@type":"Person","name":"Hugues Morisset","url":"https://blog.izissise.net/about"},"datePublished":"2024-11-04"}</script><title>Nginx Explorer - Cookie Authentication</title><meta property="og:title" content="Nginx Explorer - Cookie Authentication"><script defer src=/js/codecopy.js></script><script defer src=/js/ofuscate.js></script><script data-goatcounter=https://izissise.goatcounter.com/count async src=/js/count.js></script><noscript><img style=display:none src="https://izissise.goatcounter.com//count?p=/posts/ngxp-cookie-auth/&t=Nginx Explorer - Cookie Authentication"></noscript><link rel=alternate type=application/atom+xml title href=/atom.xml><link rel=stylesheet media=screen href=/main.css><div class=content><header><nav><a href=/posts style=margin-left:.7em>/posts</a>
<a href=/about style=margin-left:.7em>/about</a>
<a href=/atom.xml style=margin-left:.7em>/rss</a>
|
<i id=mode class="adjust icon" type=reset></i>
<script src=/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Nginx Explorer - Cookie Authentication</div><div class=meta><span>Posted on <time>2024-11-04</time></span>
<span style=float:right;text-align:right>3 minutes read</span></div></div><section class=body><p><a href=/posts/ngxp-listing/>Previously</a>, we configured <code>nginx</code> to list directories and files in html.
Now, letâ€™s add authentication to restrict access to specific directories and files.<h1 id=basic-authentication><a class=zola-anchor href=#basic-authentication aria-label="Anchor link for: basic-authentication">Basic authentication</a></h1><p>The simplest web authentication method is <a rel=noopener target=_blank href=https://en.wikipedia.org/wiki/Basic_access_authentication>basic authentication</a>.
It requires an <code>Authorization</code> header in each request.
However, browsers donâ€™t support setting a header on requests without javascript,
and with javascript, thereâ€™s no sane way to stream file downloads to the browserâ€™s download manager.<p>So, once the initial basic auth login is validated, we'll use cookies, which browsers automatically include for each request on the same site.<p>Letâ€™s start by creating a <code>login</code> endpoint with <a rel=noopener target=_blank href=http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html>nginx basic auth</a> to verify the user/password pair and set a cookie for users with valid credentials.<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-storage z-type z-context z-nginx">server</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    ...
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    <span class="z-meta z-context z-location z-nginx"><span class="z-storage z-type z-context z-location z-nginx">location</span> <span class="z-entity z-name z-context z-location z-nginx">@login_success </span>{
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-headers z-nginx">add_header</span> Set-Cookie <span class="z-string z-quoted z-double z-nginx">&quot;ngxp=???; max-age=15552000; path=/; SameSite=Lax; Secure; HttpOnly&quot;</span>;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-support z-function z-module z-http z-rewrite z-nginx">return</span> <span class="z-string z-ipaddress z-nginx">200</span> <span class="z-string z-quoted z-double z-nginx">&quot;login success&quot;</span>;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">    }</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    <span class="z-meta z-context z-location z-nginx"><span class="z-storage z-type z-context z-location z-nginx">location</span> ^~ <span class="z-string z-regexp z-nginx">/___ngxp/login </span>{
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-auth_basic z-nginx">auth_basic</span> <span class="z-string z-quoted z-double z-nginx">&quot;Login&quot;</span>;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">auth_delay</span> 1s;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-auth_basic z-nginx">auth_basic_user_file</span> /opt/ngxp/basic.htpasswd;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-nginx">try_files</span> _ @login_success;</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">    }</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">}</span>
</span></code></pre><p>To create entries in <code>basic.htpasswd</code>, we use openssl<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>:<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>%s:%s\n<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">user</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">openssl</span></span><span class="z-meta z-function-call z-arguments z-shell"> passwd<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>5</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">password</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span> <span class="z-keyword z-operator z-assignment z-redirection z-shell">&gt;&gt;</span> basic.htpasswd</span>
</span></code></pre><p>We can successfully login using basic auth on the <code>login</code> endpoint!<h1 id=cookie-set><a class=zola-anchor href=#cookie-set aria-label="Anchor link for: cookie-set">Cookie set</a></h1><p>To check that the user is authorized to access the current path and
that cookies cannot be hand-crafted,
we need to store the following in the cookie:<ul><li>username<li>a secret, so a cookie cannot be hand crafted<li>the paths base the user has access to</ul><p>Using <a rel=noopener target=_blank href=http://nginx.org/en/docs/http/ngx_http_map_module.html>nginx map module</a>, weâ€™ll store this information for each user:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx"><span class="z-comment z-line z-number-sign">#     input     output</span>
</span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx"><span class="z-storage z-type z-context z-nginx">map</span> <span class="z-variable z-other z-nginx">$username</span> <span class="z-variable z-other z-nginx">$user_cookie</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">   <span class="z-constant z-language z-nginx"> default</span> <span class="z-string z-quoted z-double z-nginx">&quot;&quot;</span><span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">    admin   admin|d31d6b17bbc4df3ccb78d99db085e9d347b3e042e65d5878|/<span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">    alice   alice|2406b10bfd4c356394a647d5657bde937124f602198f20f3|/alicefiles<span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">    bob     bob|3f02f891206f421739edb7565d746a493653c4dfb01b6042|/bob|/photos<span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">}</span>
</span></code></pre><p>Later, with map's <code>include</code> directive we can store it into a file.<p>In <code>@login_success</code>, assign the <code>ngxp</code> cookie value.
When <code>$username</code> is set with the basic auth username (<code>$remote_user</code>), <code>$user_cookie</code> is set with the mapped value.<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">    <span class="z-meta z-context z-location z-nginx"><span class="z-storage z-type z-context z-location z-nginx">location</span> <span class="z-entity z-name z-context z-location z-nginx">@login_success </span>{
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-rewrite z-nginx">set</span> <span class="z-variable z-other z-nginx">$username</span> <span class="z-variable z-other z-nginx">$remote_user</span>;</span> <span class="z-comment z-line z-number-sign"># $remote_user is the basic_auth user in Authorization http header</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-http z-headers z-nginx">add_header</span> Set-Cookie <span class="z-string z-quoted z-double z-nginx">&quot;ngxp=<span class="z-variable z-other z-nginx">$user_cookie</span>; max-age=15552000; path=/; SameSite=Lax; Secure; HttpOnly&quot;</span>;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-punctuation z-definition z-variable"><span class="z-support z-function z-module z-http z-rewrite z-nginx">return</span> <span class="z-string z-ipaddress z-nginx">200</span> <span class="z-string z-quoted z-double z-nginx">&quot;login success&quot;</span>;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-location z-nginx">    }</span>
</span></code></pre><h1 id=cookie-check><a class=zola-anchor href=#cookie-check aria-label="Anchor link for: cookie-check">Cookie check</a></h1><p>The only thing left to do is to check if our cookie is valid and authorized for the current uri when listing files.
<code>$cookie_ngxp</code> contains the http request provided cookie (from the browser).<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx"><span class="z-comment z-line z-number-sign"># get username from http request&#39;s cookie</span>
</span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx"><span class="z-storage z-type z-context z-nginx">map</span> <span class="z-variable z-other z-nginx">$cookie_ngxp</span> <span class="z-variable z-other z-nginx">$username</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">    <span class="z-string z-regexp z-nginx">~</span><span class="z-string z-regexp z-nginx">^(?&lt;var&gt;[^\|]+)\|.* $</span>var<span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">   <span class="z-constant z-language z-nginx"> default</span>              <span class="z-string z-quoted z-double z-nginx">&quot;&quot;</span><span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">}</span>
</span></code></pre><p>It's an untrusted user input, so we should check that
it matches exactly with the one set for the username.<p>Since we just set <code>$username</code>, <code>$user_cookie</code> has the trusted cookie value for the user (if it exists),
so we check that both variables are equal:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx"><span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">map</span> ${cookie_ngxp}<span class="z-string z-regexp z-nginx">\\${user_cookie} $user_cookie_equal </span>{</span>
</span><span class="z-source z-nginx">    ~^([^\x5c]+)\x5c\1$ 1; <span class="z-comment z-line z-number-sign"># if $user_cookie == $cookie_ngxp  (\ == \x5c)</span>
</span><span class="z-source z-nginx">    <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">default</span>             0;</span>
</span><span class="z-source z-nginx">}
</span></code></pre><p>By modifying <code>location /</code> slightly, we can already restrict listing and download to requests with a valid cookie:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-storage z-type z-context z-nginx">server</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    ...
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    <span class="z-meta z-context z-location z-nginx"><span class="z-storage z-type z-context z-location z-nginx">location</span> <span class="z-entity z-name z-context z-location z-nginx">/ </span>{
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-keyword z-control z-nginx">if</span> (<span class="z-variable z-other z-nginx">$user_cookie_equal</span> = 0) <span class="z-meta z-block z-nginx">{ <span class="z-punctuation z-definition z-variable"><span class="z-support z-function z-module z-http z-rewrite z-nginx">return</span> <span class="z-string z-ipaddress z-nginx">401</span>;</span> }</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        ...
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">    }</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">}</span>
</span></code></pre><h1 id=cookie-access><a class=zola-anchor href=#cookie-access aria-label="Anchor link for: cookie-access">Cookie access</a></h1><p>We also want to have per path access rights, we first extract the path from <code>$user_cookie</code>:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx"><span class="z-storage z-type z-context z-nginx">map</span> <span class="z-variable z-other z-nginx">$user_cookie</span> <span class="z-variable z-other z-nginx">$user_cookie_accesses</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">    <span class="z-string z-regexp z-nginx">~</span><span class="z-string z-regexp z-nginx">^([^\|]+)\|([^\|]+)\|(?&lt;var&gt;.+)$</span> <span class="z-variable z-other z-nginx">$var</span><span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">   <span class="z-constant z-language z-nginx"> default</span>                           <span class="z-string z-quoted z-double z-nginx">&quot;&quot;</span><span class="z-punctuation z-definition z-map z-nginx">;</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-map z-nginx">}</span>
</span></code></pre><p>Using a map with two variable as input, we can check if <a rel=noopener target=_blank href=http://nginx.org/en/docs/http/ngx_http_core_module.html#var_uri><code>$uri</code></a>
starts with the extracted path<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">map</span> ${user_cookie_accesses}<span class="z-string z-regexp z-nginx">\\${uri} $uri_access { # request uri </span>access</span>
</span><span class="z-source z-nginx">    ~^(|[^\x5c]*\|)([^\|]+)(\x5c|\|[^\x5c]*\x5c)\2((?&lt;=\/)|$|\/).*$ 1; <span class="z-comment z-line z-number-sign"># if $user_cookie_accesses contains $uri (\ - \x5c)</span>
</span><span class="z-source z-nginx">    <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">default</span>                                                         0;</span>
</span><span class="z-source z-nginx">}
</span></code></pre><h1 id=cookie-authorized><a class=zola-anchor href=#cookie-authorized aria-label="Anchor link for: cookie-authorized">Cookie authorized</a></h1><p>Finally, ensure that both the cookie and path-based access rights are validated:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">map</span> ${user_cookie_equal}${uri_access} <span class="z-variable z-other z-nginx">$user_authorized</span> {</span>
</span><span class="z-source z-nginx">    <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">11</span>          1;</span> <span class="z-comment z-line z-number-sign"># everything ok, authorize</span>
</span><span class="z-source z-nginx">    <span class="z-punctuation z-definition z-variable"><span class="z-keyword z-directive z-module z-unsupported z-nginx">default</span>     0;</span>
</span><span class="z-source z-nginx">}
</span></code></pre><p>In the file listing endpoint, check <code>$user_authorized</code>:<pre data-lang=nginx data-name=default.conf class="language-nginx z-code"><code class=language-nginx data-lang=nginx data-name=default.conf><span class="z-source z-nginx">...
</span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-storage z-type z-context z-nginx">server</span> {
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    ...
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">    <span class="z-meta z-context z-location z-nginx"><span class="z-storage z-type z-context z-location z-nginx">location</span> <span class="z-entity z-name z-context z-location z-nginx">/ </span>{
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        <span class="z-keyword z-control z-nginx">if</span> (<span class="z-variable z-other z-nginx">$user_authorized</span> = 0) <span class="z-meta z-block z-nginx">{ <span class="z-punctuation z-definition z-variable"><span class="z-support z-function z-module z-http z-rewrite z-nginx">return</span> <span class="z-string z-ipaddress z-nginx">401</span>;</span> }</span>
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">        ...
</span></span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx"><span class="z-meta z-context z-location z-nginx">    }</span>
</span></span><span class="z-source z-nginx"><span class="z-meta z-context z-server z-nginx">}</span>
</span></code></pre><p>We now have per user and path accesses!<p><a href=/posts/ngxp-upload/>Next time we'll see how to upload files</a>.<section class=footnotes><ol class=footnotes-list><li id=fn-1><p>You can also use htpasswd. <a href=#fr-1-1>â†©</a></ol></section></section></article></main></div><footer><hr><nav style=float:right><a rel=me href=/about>Hugues</a> |
<a rel=atom href=/atom.xml class="rss icon"></a><a rel=me href=https://github.com/izissise class="github icon" style=border-bottom:none></a><a rel=me href=https://stackoverflow.com/users/2838914/izissise class="stack icon" style=border-bottom:none></a><a rel=me href=https://links.izissise.net/ class="shaarli icon" style=border-bottom:none></a><a rel=me href=https://www.linkedin.com/in/huguesmorisset/ class="linkedin icon" style=border-bottom:none></a><a rel=me href="=MWM2IDZ1cDN0ATMwEDMyEjYxEmM5QDMwIWNmFjYxQDMkFDNyYDNxATMygDNwEDOwEWM3MjM1QDM" class="m-protected matrix icon" style=border-bottom:none></a><a rel=me href="==wYwQWMiBjZ0QDMhJjM1QDM2AjMzIWM0ADZxQjM2QTMwYGN2ADZwITMiFTYyEDN2AzYwgDN3ATNxQDMhJjM1QDM" class="m-protected mail icon" style=border-bottom:none></a>| &#169; 2025