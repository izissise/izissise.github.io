<!doctype html><html lang=en><html class="dark light"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"><link rel=monetization href=https://ilp.gatehub.net/669637781/eur><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Raconn - Ssh multi hostname","author":{"@type":"Person","name":"Hugues Morisset","url":"https://blog.izissise.net/about"},"datePublished":"2025-10-24"}</script><title>Raconn - Ssh multi hostname</title><meta property="og:title" content="Raconn - Ssh multi hostname"><script defer src=/js/codecopy.js></script><script defer src=/js/ofuscate.js></script><script data-goatcounter=https://izissise.goatcounter.com/count async src=/js/count.js></script><noscript><img style=display:none src="https://izissise.goatcounter.com//count?p=/posts/raconn/&t=Raconn - Ssh multi hostname"></noscript><link rel=alternate type=application/atom+xml title href=/atom.xml><link rel=stylesheet media=screen href=/main.css><div class=content><header><nav><a href=/posts style=margin-left:.7em>/posts</a>
<a href=/about style=margin-left:.7em>/about</a>
<a href=/atom.xml style=margin-left:.7em>/rss</a>
|
<i id=mode class="adjust icon" type=reset></i>
<script src=/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Raconn - Ssh multi hostname</div><div class=meta><span>Posted on <time>2025-10-24</time></span>
<span style=float:right;text-align:right>6 minutes read</span></div></div><section class=body><p>TLDR: <a href=/posts/raconn/#raconn>Raconn</a><h1 id=introduction><a class=zola-anchor href=#introduction aria-label="Anchor link for: introduction">Introduction</a></h1><p>Recently I wanted to connect to a local machine with ssh but didn't know it's IP, I knew the MAC address which I could translate into the IPv6 link-local address but since the <code>connect</code> syscall requires the local iface name for ip6 link local, it would need to be hardcoded in the ssh config, making it inconvenient to change. Also if the same machine is accessible from a wider network, I'd need a second entry in the config and have to remember which one to use depending on which network my computer is connected to.<p>Thatâ€™s a lot of complexity and I thought most of it could be solved if ssh config allowed multiple hostnames for a single host entry.<p>Unfortunately, <code>OpenSSH</code>'s <code>Hostname</code> directive doesn't support multiple entries:<pre class=z-code><code><span class="z-text z-plain">Host machineA
</span><span class="z-text z-plain">  Hostname machinea.local 192.168.1.65 2a00:1450:4007:81a::200e 142.250.201.174 00:00:07:00:00:00 ...
</span><span class="z-text z-plain">  Port 22
</span><span class="z-text z-plain">  User admin
</span><span class="z-text z-plain">  PubkeyAuthentication yes
</span><span class="z-text z-plain">  IdentityFile ~/.ssh/id_rsa
</span></code></pre><p>But thereâ€™s a silver lining <code>ProxyCommand</code>. It runs a program thatâ€™s expected to connect to the remote machine, <code>OpenSSH</code> will simply speaks its protocol through the program's <code>stdin</code> and <code>stdout</code>!<p>Which means I can do the following:<pre data-name=~/.ssh/config class=z-code><code data-name=~/.ssh/config><span class="z-text z-plain">Host machineA
</span><span class="z-text z-plain">  ProxyCommand program %p machine.company.net 192.168.1.65 2a00:1450:4007:81a::200e 142.250.201.174 00:00:07:00:00:00 ...
</span><span class="z-text z-plain">  Port 22
</span><span class="z-text z-plain">  User admin
</span><span class="z-text z-plain">  PubkeyAuthentication yes
</span><span class="z-text z-plain">  IdentityFile ~/.ssh/id_rsa
</span></code></pre><p>I just need to figure out what <code>program</code> is.<h1 id=socat><a class=zola-anchor href=#socat aria-label="Anchor link for: socat">Socat</a></h1><p>It seems like a shell script using <code>socat</code> would be perfect for the job, I was able to get a serialized version working, but since it tried every hostname one after another, it could take a long time to connect, especially if only the last one on the command line was reachable.<p>The main issue I had was that socat executes the script defined on the <code>exec</code> statement before the connection is successfully established making it hard to know which socat instance is connected when spawning multiple ones in parallel.<p><a rel=noopener target=_blank href=https://web.archive.org/web/20250318111137/https://stackoverflow.com/questions/79497821/how-to-execute-a-script-only-after-a-successful-tcp-connection-with-socat>stackoverflow</a><p>In the end, I decided to write this program myself.<h1 id=raconn><a class=zola-anchor href=#raconn aria-label="Anchor link for: raconn">Raconn</a></h1><p>Enter <code>raconn</code> (short for RAce CONNect) is a utility that accepts a list of hostnames and IP addresses as arguments. It attempts to connect to all of them in parallel using separate threads and retains the first successful connection cancelling all the remaining threads. Once connected, it proxies data between stdin and stdout, making it suitable for use as an SSH ProxyCommand.<p><a rel=noopener target=_blank href=https://github.com/izissise/raconn>Git repository</a><p>It is written in C using <a rel=noopener target=_blank href=https://github.com/jart/cosmopolitan>cosmopolitan libc</a>, Some reasons for this choice:<ul><li>Runs on all major operating systems with a unique static binary<li>Easy 'C' development thanks to sane api defaults<li>Debug enviroment included</ul><p>Also I'm addicted to sugar so I added <a rel=noopener target=_blank href=https://github.com/aartaka/pretty.c>pretty.c</a> in the mix.<h1 id=examples><a class=zola-anchor href=#examples aria-label="Anchor link for: examples">Examples</a></h1><blockquote class=example><p class=box-title><i class=icon></i>example<div></div><p>Letâ€™s say you have a server with two ifaces, one used for failover,
if you specify both ip to raconn, even in a failover
situation, your ssh command will succeed by connecting
through the second iface and ip. <code>$ ssh ip4failover</code><pre data-name=~/.ssh/config class=z-code><code data-name=~/.ssh/config><span class="z-text z-plain">Host ip4failover
</span><span class="z-text z-plain">  ProxyCommand raconn %p 233.252.3.1 233.252.4.1
</span><span class="z-text z-plain">  Port 22
</span><span class="z-text z-plain">  User admin
</span></code></pre></blockquote><blockquote class=example><p class=box-title><i class=icon></i>example<div></div><p>You have a machine that is accessible on your local network
and from outside. You only known the machine MAC address and
its name which resolve to a WAN ip.
Locally your are connected through both wifi and ethernet.
<code>$ ssh machine</code><pre data-name=~/.ssh/config class=z-code><code data-name=~/.ssh/config><span class="z-text z-plain">Host machine.company
</span><span class="z-text z-plain">  ProxyCommand raconn %p machine.company.net 00:00:07:cf:10:0a
</span><span class="z-text z-plain">  Port 22
</span><span class="z-text z-plain">  User admin
</span></code></pre></blockquote><blockquote class=example><p class=box-title><i class=icon></i>example<div></div><p>You're trying to figuring out something and <code>raconn</code> is
getting in the way. <code>$ ssh -oProxyCommand=none machine.company.net</code><pre data-name=~/.ssh/config class=z-code><code data-name=~/.ssh/config><span class="z-text z-plain">Host machine.company.net
</span><span class="z-text z-plain">  ProxyCommand raconn %p 2a00:1450:4007:81a::200e fe80::9e4f:642a:15c2:aad7
</span><span class="z-text z-plain">  Port 22
</span><span class="z-text z-plain">  User admin
</span></code></pre></blockquote><h1 id=how-is-it-made><a class=zola-anchor href=#how-is-it-made aria-label="Anchor link for: how-is-it-made">How is it made?</a></h1><h2 id=writing-c-and-dev-environment-setup><a class=zola-anchor href=#writing-c-and-dev-environment-setup aria-label="Anchor link for: writing-c-and-dev-environment-setup">Writing C and dev environment setup</a></h2><h3 id=git><a class=zola-anchor href=#git aria-label="Anchor link for: git">Git</a></h3><p><code>Raconn</code> is a small project and it only needs only a few versioned files.
For the first time I tried using <code>.gitignore</code> as an allowlist:<pre data-lang=.gitignore class="language-.gitignore z-code"><code class=language-.gitignore data-lang=.gitignore><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># ignore everything
</span></span></span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">*</span>
</span><span class="z-source z-genconfig"><span class="z-meta z-comment z-genconfig"><span class="z-comment z-line z-number-sign z-genconfig"># except for these
</span></span></span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span><span class="z-keyword z-operator z-genconfig">.</span>gitignore
</span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span>main<span class="z-keyword z-operator z-genconfig">.</span>c
</span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span>Makefile
</span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span><span class="z-support z-constant z-genconfig">README</span><span class="z-keyword z-operator z-genconfig">.</span>md
</span><span class="z-source z-genconfig"><span class="z-keyword z-operator z-genconfig">!</span><span class="z-keyword z-operator z-genconfig">/</span><span class="z-support z-constant z-genconfig">LICENSE</span>
</span></code></pre><p>This has the nice property that no new files or artifacts can be tracked by mistake, and <code>git status</code> always stays clean.<h3 id=makefile><a class=zola-anchor href=#makefile aria-label="Anchor link for: makefile">Makefile</a></h3><p>For easy build and QA, I use a <code>Makefile</code> with targets for build, format and lint.<p>It will also downloads the <code>cosmopolitan</code> toolchain and sets up the <a rel=noopener target=_blank href=https://en.wikipedia.org/wiki/Language_Server_Protocol>LSP</a> support to get errors and warnings directly in <a rel=noopener target=_blank href=https://kate-editor.org/>kate</a>
my source editor of choice.<p>After <a rel=noopener target=_blank href=https://github.com/clangd/clangd/issues/1038#issuecomment-2614169354>some research</a>, I found that I needed to create two files for <code>clangd</code> LSP to correctly support <code>cosmopolitan</code>:<pre data-lang=json data-name=compile_commands.json class="language-json z-code"><code class=language-json data-lang=json data-name=compile_commands.json><span class="z-source z-json"><span class="z-meta z-sequence z-json"><span class="z-punctuation z-section z-sequence z-begin z-json">[</span><span class="z-punctuation z-section z-sequence z-end z-json">]</span></span>
</span></code></pre><p>and<pre data-lang=yaml data-name=.clangd class="language-yaml z-code"><code class=language-yaml data-lang=yaml data-name=.clangd><span class="z-source z-yaml"><span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">CompileFlags</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">        <span class="z-string z-unquoted z-plain z-out z-yaml"><span class="z-entity z-name z-tag z-yaml">Add</span></span><span class="z-punctuation z-separator z-key-value z-mapping z-yaml">:</span>
</span><span class="z-source z-yaml">                <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>-isystemcosmocc/include<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
</span><span class="z-source z-yaml">                <span class="z-punctuation z-definition z-block z-sequence z-item z-yaml">-</span> <span class="z-string z-quoted z-double z-yaml"><span class="z-punctuation z-definition z-string z-begin z-yaml">&quot;</span>-include libc/c.inc<span class="z-punctuation z-definition z-string z-end z-yaml">&quot;</span></span>
</span></code></pre><h2 id=principle><a class=zola-anchor href=#principle aria-label="Anchor link for: principle">Principle</a></h2><p><code>raconn</code> tries to connect in parallel to all addresses provided on the command line. The first successful connection cancels the others and is then piped through stdin/stdout, making it suitable for use as an ssh <code>ProxyCommand</code>.<p>The first step is to resolve each hostname into a list of IPv4 or IPv6 addresses to feed into the <code>connect</code> syscall.<h3 id=ipv6-local-link><a class=zola-anchor href=#ipv6-local-link aria-label="Anchor link for: ipv6-local-link">Ipv6 local link</a></h3><p>Some notes on IPv6 link local addresses,<p>IpV6 has a set of special addresses called link local in the range <code>fe80::/10</code>.
All network interface must be assigned one if it wants to use Ipv6.
These addresses are not routed by routers and allow for ipv6 devices to talk to each other
without a router on the same link.<p>Because ip6 link local addresses are usually derived from the network interface's mac address, that makes them
predictable and so it would be nice to be able to use them to connect to the remote machine.<p>The problem is that, unlike IPv4 and global IPv6 addresses (where only the destination address is needed), link local addresses require specifying the interface index in <code>struct sockaddr_in6</code> when using <code>connect</code>.<p>Since I donâ€™t want to ask the user which network interface shares a link with the remote machine, I simply perform a <code>connect</code> syscall for every network interface on the local machine.<p>So a list of locally attached network interfaces is needed, but as of 2025 <code>getifaddrs</code> in cosmopolitan is
only implemented for IPv4.<p>That became a whole side quest, implemented across 3 PRs:<ul><li><a rel=noopener target=_blank href=https://github.com/jart/cosmopolitan/pull/1415>getifaddrs Linux (merged)</a><li><a rel=noopener target=_blank href=https://github.com/jart/cosmopolitan/pull/1436>getifaddrs BSD</a><li><a rel=noopener target=_blank href=https://github.com/jart/cosmopolitan/pull/1433>getifaddrs Windows</a></ul><h3 id=dns-resolution><a class=zola-anchor href=#dns-resolution aria-label="Anchor link for: dns-resolution">DNS resolution</a></h3><p>In cosmopolitan, hostname lookup using <code>getaddrinfo</code> is the courtesy of the musl libc implementation.
As of 2025, it doesn't support <code>mDns</code> :/<p><code>getaddrinfo</code> returns a linked list of <code>struct addrinfo</code> which are the ips 4 and 6 the name resolve to.<p>If it returns an Ipv6 link-local address we have to enter the special case described earlier.<h3 id=parallel-connections><a class=zola-anchor href=#parallel-connections aria-label="Anchor link for: parallel-connections">Parallel connections</a></h3><p>Because <code>getaddrinfo</code> <code>getaddrlist</code> <code>connect</code> etc are blocking calls, I spawn one thread
per arguments on the command line each with a small stack size (see cosmo's greenbean).<p>This way all names are tried simultaneously, making the connections truly racy.<h3 id=io-fun><a class=zola-anchor href=#io-fun aria-label="Anchor link for: io-fun">IO fun</a></h3><p>To ensure only one connection is kept, I use an atomic variable that is only set once.<p>The winning connection then spawns two final threads that that effectively pipe the socket through stdin/stdout.<h3 id=timeout><a class=zola-anchor href=#timeout aria-label="Anchor link for: timeout">Timeout</a></h3><p>Since <code>raconn</code> will mostly be used in interactive contexts, I want it to fail fast when no hostname is reachable.
Unfortunately, Posix's <code>connect</code> doesn't give any easy way to choose a timeout after which the connect should fail.<p>So, I spawn a sibling thread before calling <code>connect</code> and <code>getaddrinfo</code> that will <code>pthread_cancel</code> on the connecting thread
after a timeout. If <code>connect</code> succeeds first, it cancels the timeout thread instead.<h1 id=closing-words><a class=zola-anchor href=#closing-words aria-label="Anchor link for: closing-words">Closing words</a></h1><p>You can find <code>raconn</code> <a rel=noopener target=_blank href=https://github.com/izissise/raconn>here</a>.<p>Computer addressing is a bit of a mess, but at least itâ€™s possible to abstract some of it once you understand its quirks.</section></article></main></div><footer><hr><nav style=float:right><a rel=me href=/about>Hugues</a> |
<a rel=atom href=/atom.xml class="rss icon"></a><a rel=me href=https://github.com/izissise class="github icon" style=border-bottom:none></a><a rel=me href=https://stackoverflow.com/users/2838914/izissise class="stack icon" style=border-bottom:none></a><a rel=me href=https://links.izissise.net/ class="shaarli icon" style=border-bottom:none></a><a rel=me href=https://www.linkedin.com/in/huguesmorisset/ class="linkedin icon" style=border-bottom:none></a><a rel=me href="=MWM2IDZ1cDN0ATMwEDMyEjYxEmM5QDMwIWNmFjYxQDMkFDNyYDNxATMygDNwEDOwEWM3MjM1QDM" class="m-protected matrix icon" style=border-bottom:none></a><a rel=me href="==wYwQWMiBjZ0QDMhJjM1QDM2AjMzIWM0ADZxQjM2QTMwYGN2ADZwITMiFTYyEDN2AzYwgDN3ATNxQDMhJjM1QDM" class="m-protected mail icon" style=border-bottom:none></a>| &#169; 2025