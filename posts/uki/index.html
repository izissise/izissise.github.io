<!doctype html><html lang=en><html class="dark light"><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§±</text></svg>"><link rel=monetization href=https://ilp.gatehub.net/669637781/eur><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Unified Kernel Image","author":{"@type":"Person","name":"Hugues Morisset","url":"https://blog.izissise.net/about"},"datePublished":"2024-07-12"}</script><title>Unified Kernel Image</title><meta property="og:title" content="Unified Kernel Image"><script defer src=/js/codecopy.js></script><script defer src=/js/ofuscate.js></script><script data-goatcounter=https://izissise.goatcounter.com/count async src=/js/count.js></script><noscript><img style=display:none src="https://izissise.goatcounter.com//count?p=/posts/uki/&t=Unified Kernel Image"></noscript><link rel=alternate type=application/atom+xml title href=/atom.xml><link rel=stylesheet media=screen href=/main.css><div class=content><header><nav><a href=/posts style=margin-left:.7em>/posts</a>
<a href=/about style=margin-left:.7em>/about</a>
<a href=/atom.xml style=margin-left:.7em>/rss</a>
|
<i id=mode class="adjust icon" type=reset></i>
<script src=/js/themetoggle.js></script></nav></header><main><article><div class=title><div class=page-header>Unified Kernel Image</div><div class=meta><span>Posted on <time>2024-07-12</time></span>
<span style=float:right;text-align:right>4 minutes read</span></div></div><section class=body><h1 id=unified-kernel-image><a class=zola-anchor href=#unified-kernel-image aria-label="Anchor link for: unified-kernel-image">Unified Kernel Image</a></h1><p>UKIs can run on UEFI systems and simplify the distribution of small kernel images. For example, they simplify network booting with iPXE. UKIs make rootfs and kernels composable, making it possible to derive a rootfs for multiple kernel versions with one file for each pair.<p>A Unified Kernel Image (UKI) is a combination of a UEFI boot stub program, a Linux kernel image, an initramfs, and further resources in a single UEFI PE file (device tree, cpu Âµcode, splash screen, secure boot sig/key, ...). This file can either be directly invoked by the UEFI firmware or through a boot loader.<h1 id=the-simple-way><a class=zola-anchor href=#the-simple-way aria-label="Anchor link for: the-simple-way">The simple way</a></h1><p>If you use a systemd-based OS and want to use UKIs, you're probably better off using <a rel=noopener target=_blank href=https://www.freedesktop.org/wiki/Software/systemd/systemd-boot/>systemd-boot</a>.<p>In this post, we aim to create a ready-to-boot UKI for another machine rather than the one we are creating it from.<p>We can use <a rel=noopener target=_blank href=https://www.freedesktop.org/software/systemd/man/latest/ukify.html>ukify</a>, which is a dedicated tool to create UKIs, but I'd like to get a little more in-depth on how they are constructed.<h1 id=linux-efi><a class=zola-anchor href=#linux-efi aria-label="Anchor link for: linux-efi">Linux EFI</a></h1><p>The Linux kernel should be compiled with <code>CONFIG_EFI_STUB=y</code> see <a rel=noopener target=_blank href=https://docs.kernel.org/admin-guide/efi-stub.html>https://docs.kernel.org/admin-guide/efi-stub.html</a><blockquote class=note><p class=box-title><i class=icon></i>note<div></div><p>When building the kernel with EFI support, the final artifact name in the <code>arch/"$ARCH"/boot/</code>
directory changes. For <code>X86_64</code>, it will be named <code>bzImage</code>, but for other architectures, it will be <code>vmlinuz.efi</code>.</blockquote><p>Let's find a pre-compiled kernel in the Arch Linux repository<sup class=footnote-reference id=fr-1-1><a href=#fn-1>1</a></sup>:<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">klatest</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">curl</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>https://archive.archlinux.org/packages/l/linux/<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">xmllint</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>recover</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>html</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>xpath</span> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>string(//a[last() - 1]/@href)<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span> -</span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> We&#39;re only interested in the vmlinuz file</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">curl</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>https://archive.archlinux.org/packages/l/linux/<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-expansion z-parameter z-begin z-shell">{</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-variable z-other z-readwrite z-shell">klatest</span></span><span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-section z-expansion z-parameter z-end z-shell">}</span></span><span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">tar</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>zstd</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>wildcards</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> --</span>no-anchored</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">  --</span>transform</span><span class="z-keyword z-operator z-assignment z-option z-shell">=</span><span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>s:.*/::<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>xf</span> - <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>vmlinuz<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span>
</span></code></pre><p>We can see with <code>readpe</code> that the file is indeed a PE executable:<details><summary>readpe vmlinuz</summary><div><pre data-lang=txt class="language-txt z-code"><code class=language-txt data-lang=txt><span class="z-text z-plain">DOS Header
</span><span class="z-text z-plain">    Magic number:                    0x5a4d (MZ)
</span><span class="z-text z-plain">    Bytes in last page:              0
</span><span class="z-text z-plain">    Pages in file:                   0
</span><span class="z-text z-plain">    Relocations:                     0
</span><span class="z-text z-plain">    Size of header in paragraphs:    0
</span><span class="z-text z-plain">    Minimum extra paragraphs:        0
</span><span class="z-text z-plain">    Maximum extra paragraphs:        0
</span><span class="z-text z-plain">    Initial (relative) SS value:     0
</span><span class="z-text z-plain">    Initial SP value:                0
</span><span class="z-text z-plain">    Initial IP value:                0
</span><span class="z-text z-plain">    Initial (relative) CS value:     0
</span><span class="z-text z-plain">    Address of relocation table:     0
</span><span class="z-text z-plain">    Overlay number:                  0
</span><span class="z-text z-plain">    OEM identifier:                  0
</span><span class="z-text z-plain">    OEM information:                 0
</span><span class="z-text z-plain">    PE header offset:                0x40
</span><span class="z-text z-plain">COFF/File header
</span><span class="z-text z-plain">    Machine:                         0x8664 IMAGE_FILE_MACHINE_AMD64
</span><span class="z-text z-plain">    Number of sections:              4
</span><span class="z-text z-plain">    Date/time stamp:                 0 (Thu, 01 Jan 1970 00:00:00 UTC)
</span><span class="z-text z-plain">    Symbol Table offset:             0
</span><span class="z-text z-plain">    Number of symbols:               1
</span><span class="z-text z-plain">    Size of optional header:         0xa0
</span><span class="z-text z-plain">    Characteristics:                 0x206
</span><span class="z-text z-plain">    Characteristics names
</span><span class="z-text z-plain">                                         IMAGE_FILE_EXECUTABLE_IMAGE
</span><span class="z-text z-plain">                                         IMAGE_FILE_LINE_NUMS_STRIPPED
</span><span class="z-text z-plain">                                         IMAGE_FILE_DEBUG_STRIPPED
</span><span class="z-text z-plain">Optional/Image header
</span><span class="z-text z-plain">    Magic number:                    0x20b (PE32+)
</span><span class="z-text z-plain">    Linker major version:            2
</span><span class="z-text z-plain">    Linker minor version:            20
</span><span class="z-text z-plain">    Size of .text section:           0xc99000
</span><span class="z-text z-plain">    Size of .data section:           0x5f000
</span><span class="z-text z-plain">    Size of .bss section:            0
</span><span class="z-text z-plain">    Entrypoint:                      0xc93579
</span><span class="z-text z-plain">    Address of .text section:        0x5000
</span><span class="z-text z-plain">    ImageBase:                       0
</span><span class="z-text z-plain">    Alignment of sections:           0x1000
</span><span class="z-text z-plain">    Alignment factor:                0x200
</span><span class="z-text z-plain">    Major version of required OS:    0
</span><span class="z-text z-plain">    Minor version of required OS:    0
</span><span class="z-text z-plain">    Major version of image:          3
</span><span class="z-text z-plain">    Minor version of image:          0
</span><span class="z-text z-plain">    Major version of subsystem:      0
</span><span class="z-text z-plain">    Minor version of subsystem:      0
</span><span class="z-text z-plain">    Size of image:                   0xcfd000
</span><span class="z-text z-plain">    Size of headers:                 0x1000
</span><span class="z-text z-plain">    Checksum:                        0
</span><span class="z-text z-plain">    Subsystem required:              0xa (IMAGE_SUBSYSTEM_EFI_APPLICATION)
</span><span class="z-text z-plain">    DLL characteristics:             0x100
</span><span class="z-text z-plain">    DLL characteristics names
</span><span class="z-text z-plain">                                         IMAGE_DLLCHARACTERISTICS_NX_COMPAT
</span><span class="z-text z-plain">    Size of stack to reserve:        0
</span><span class="z-text z-plain">    Size of stack to commit:         0
</span><span class="z-text z-plain">    Size of heap space to reserve:   0
</span><span class="z-text z-plain">    Size of heap space to commit:    0
</span><span class="z-text z-plain">Data directories
</span><span class="z-text z-plain">Imported functions
</span><span class="z-text z-plain">Exported functions
</span><span class="z-text z-plain">Sections
</span><span class="z-text z-plain">    Section
</span><span class="z-text z-plain">        Name:                            .setup
</span><span class="z-text z-plain">        Virtual Size:                    0x3000 (12288 bytes)
</span><span class="z-text z-plain">        Virtual Address:                 0x1000
</span><span class="z-text z-plain">        Size Of Raw Data:                0x3000 (12288 bytes)
</span><span class="z-text z-plain">        Pointer To Raw Data:             0x1000
</span><span class="z-text z-plain">        Number Of Relocations:           0
</span><span class="z-text z-plain">        Characteristics:                 0x42000040
</span><span class="z-text z-plain">        Characteristic Names
</span><span class="z-text z-plain">                                             IMAGE_SCN_CNT_INITIALIZED_DATA
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_DISCARDABLE
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_READ
</span><span class="z-text z-plain">    Section
</span><span class="z-text z-plain">        Name:                            .compat
</span><span class="z-text z-plain">        Virtual Size:                    0x1000 (4096 bytes)
</span><span class="z-text z-plain">        Virtual Address:                 0x4000
</span><span class="z-text z-plain">        Size Of Raw Data:                0x1000 (4096 bytes)
</span><span class="z-text z-plain">        Pointer To Raw Data:             0x4000
</span><span class="z-text z-plain">        Number Of Relocations:           0
</span><span class="z-text z-plain">        Characteristics:                 0x42000040
</span><span class="z-text z-plain">        Characteristic Names
</span><span class="z-text z-plain">                                             IMAGE_SCN_CNT_INITIALIZED_DATA
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_DISCARDABLE
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_READ
</span><span class="z-text z-plain">    Section
</span><span class="z-text z-plain">        Name:                            .text
</span><span class="z-text z-plain">        Virtual Size:                    0xc99000 (13209600 bytes)
</span><span class="z-text z-plain">        Virtual Address:                 0x5000
</span><span class="z-text z-plain">        Size Of Raw Data:                0xc99000 (13209600 bytes)
</span><span class="z-text z-plain">        Pointer To Raw Data:             0x5000
</span><span class="z-text z-plain">        Number Of Relocations:           0
</span><span class="z-text z-plain">        Characteristics:                 0x60000020
</span><span class="z-text z-plain">        Characteristic Names
</span><span class="z-text z-plain">                                             IMAGE_SCN_CNT_CODE
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_EXECUTE
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_READ
</span><span class="z-text z-plain">    Section
</span><span class="z-text z-plain">        Name:                            .data
</span><span class="z-text z-plain">        Virtual Size:                    0x5f000 (389120 bytes)
</span><span class="z-text z-plain">        Virtual Address:                 0xc9e000
</span><span class="z-text z-plain">        Size Of Raw Data:                0x1200 (4608 bytes)
</span><span class="z-text z-plain">        Pointer To Raw Data:             0xc9e000
</span><span class="z-text z-plain">        Number Of Relocations:           0
</span><span class="z-text z-plain">        Characteristics:                 0xc0000040
</span><span class="z-text z-plain">        Characteristic Names
</span><span class="z-text z-plain">                                             IMAGE_SCN_CNT_INITIALIZED_DATA
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_READ
</span><span class="z-text z-plain">                                             IMAGE_SCN_MEM_WRITE
</span></code></pre></div></details><p>With this, we can already boot Linux directly from the UEFI:<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qemu-system-x86_64</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> 512M<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>enable-kvm</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>nographic</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>cpu</span> host<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>bios</span> /usr/share/ovmf/OVMF.fd<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>drive</span> file=fat:rw:./,format=raw</span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> Press ESC to enter uefi shell</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">fs0:vmlinuz</span></span><span class="z-meta z-function-call z-arguments z-shell"> console=ttyS0 loglevel=6</span>
</span></code></pre><iframe loading=lazy width=656 height=443 class=center frameborder=0 type=text/svg+xml src=/posts/uki/efi_kernel.term.svg data-display-frame=1715></iframe><p>The kernel crashed because there is no root FS, but it successfully booted as an EFI app.<h1 id=sd-boot><a class=zola-anchor href=#sd-boot aria-label="Anchor link for: sd-boot">SD Boot</a></h1><p>Linux doesn't support UKIs directly, so we need glue code to copy UKI sections to memory and pass control to Linux.
In the future UKI might directly be supported by the kernel, see <a rel=noopener target=_blank href=https://github.com/rhboot/nmbl-poc>nmbl</a>.<p>For now, we need to compile systemd efi stub as the bootloader to put in the UKI so it copies Linux and initrd to the right place in memory, displays the splash screen, measures secure boot values, and finally gives control to Linux with the cmdline and dtb.<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">git</span></span><span class="z-meta z-function-call z-arguments z-shell"> clone https://github.com/systemd/systemd.git</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> systemd</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">meson</span></span><span class="z-meta z-function-call z-arguments z-shell"> setup build</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-support z-function z-cd z-shell">cd</span></span><span class="z-meta z-function-call z-arguments z-shell"> build</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">ninja</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/boot/efi/linuxx64.efi.stub</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> src/boot/efi/linuxx64.efi.stub ../../uki_base.efi</span>
</span></code></pre><h1 id=populating-uki><a class=zola-anchor href=#populating-uki aria-label="Anchor link for: populating-uki">Populating UKI</a></h1><p>UKIs have a <code>PE</code> file layout with standardized sections<sup class=footnote-reference id=fr-2-1><a href=#fn-2>2</a></sup>. We will use the following:<ul><li><code>.linux</code> where we put the kernel; we can just copy <code>vmlinuz</code><li><code>.osrel</code> a key-value file with metadata about the booted image<li><code>.initrd</code> the initramfs that will be loaded with the kernel</ul><p>Previously we <a href="/posts/initramfs/#:~:text=If%20you%27re%20following%20along,archive%21">built a minimal rootfs</a> that we are going to use in our UKI<p>Creating a UKI involves mainly <code>objcopy</code> with the right parameters to pack all data into one <code>PE</code> file.<p>We create two files that will be the UKI metadata and kernel command line:<pre data-lang=txt class="language-txt z-code"><code class=language-txt data-lang=txt><span class="z-text z-plain"># cmdline.txt
</span><span class="z-text z-plain">console=ttyS0 loglevel=6
</span></code></pre><pre data-lang=txt class="language-txt z-code"><code class=language-txt data-lang=txt><span class="z-text z-plain"># osrel.txt
</span><span class="z-text z-plain">NAME=UKI
</span><span class="z-text z-plain">PRETTY_NAME=UKI
</span><span class="z-text z-plain">VERSION_CODENAME=1
</span><span class="z-text z-plain">ID=1
</span><span class="z-text z-plain">BUILD_ID=1
</span></code></pre><p>We have <code>uki_base.efi</code> our shell UKI image; we now just have to fill the aforementioned sections.<p>The composition can be done in any order using multiple calls to <code>objcopy</code>.<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> sd_boot_stub randomize the virtual memory address (vma) so we first need to get the `IMAGE_BASE` to put the section after the base.</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> we give enough room between sections vma so they don&#39;t overlap for big files</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-storage z-modifier z-shell">export</span> <span class="z-variable z-other z-readwrite z-assignment z-shell">IMAGE_BASE</span><span class="z-keyword z-operator z-assignment z-shell">=</span><span class="z-string z-unquoted z-shell"><span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">objdump</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>x</span> <span class="z-string z-quoted z-double z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&quot;</span>uki_base.efi<span class="z-punctuation z-definition z-string z-end z-shell">&quot;</span></span></span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">grep</span></span><span class="z-meta z-function-call z-arguments z-shell"> ImageBase</span> <span class="z-keyword z-operator z-logical z-pipe z-shell">|</span> <span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">awk</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-string z-quoted z-single z-shell"><span class="z-punctuation z-definition z-string z-begin z-shell">&#39;</span>{print $2}<span class="z-punctuation z-definition z-string z-end z-shell">&#39;</span></span></span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span></span></span>
</span><span class="z-source z-shell z-bash"><span class="z-comment z-line z-number-sign z-shell"><span class="z-punctuation z-definition z-comment z-begin z-shell">#</span></span><span class="z-comment z-line z-number-sign z-shell"> copy files into UKI section</span><span class="z-comment z-line z-number-sign z-shell">
</span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">objcopy</span></span><span class="z-meta z-function-call z-arguments z-shell"> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>add-section</span> .osrel=osrel.txt <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>add-section</span> .cmdline=cmdline.txt <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>add-section</span> .initrd=initramfs.cpio <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>add-section</span> .linux=vmlinuz <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>change-section-vma</span> .osrel=<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span> <span class="z-meta z-group z-arithmetic z-shell"><span class="z-punctuation z-section z-arithmetic z-begin z-shell">((</span> off <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-constant z-numeric z-integer z-other z-shell"><span class="z-punctuation z-definition z-numeric z-base z-shell">16#</span>00020000</span> <span class="z-keyword z-operator z-arithmetic z-shell">+</span> <span class="z-constant z-numeric z-integer z-decimal z-shell">16</span>#<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IMAGE_BASE</span></span> <span class="z-punctuation z-section z-arithmetic z-end z-shell">))</span></span><span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">x</span></span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">off</span></span> </span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>change-section-vma</span> .cmdline=<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span> <span class="z-meta z-group z-arithmetic z-shell"><span class="z-punctuation z-section z-arithmetic z-begin z-shell">((</span> off <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-constant z-numeric z-integer z-other z-shell"><span class="z-punctuation z-definition z-numeric z-base z-shell">16#</span>00020200</span> <span class="z-keyword z-operator z-arithmetic z-shell">+</span> <span class="z-constant z-numeric z-integer z-decimal z-shell">16</span>#<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IMAGE_BASE</span></span> <span class="z-punctuation z-section z-arithmetic z-end z-shell">))</span></span><span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">x</span></span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">off</span></span> </span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>change-section-vma</span> .initrd=<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span> <span class="z-meta z-group z-arithmetic z-shell"><span class="z-punctuation z-section z-arithmetic z-begin z-shell">((</span> off <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-constant z-numeric z-integer z-other z-shell"><span class="z-punctuation z-definition z-numeric z-base z-shell">16#</span>00100000</span> <span class="z-keyword z-operator z-arithmetic z-shell">+</span> <span class="z-constant z-numeric z-integer z-decimal z-shell">16</span>#<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IMAGE_BASE</span></span> <span class="z-punctuation z-section z-arithmetic z-end z-shell">))</span></span><span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">x</span></span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">off</span></span> </span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>change-section-vma</span> .linux=<span class="z-meta z-group z-expansion z-command z-parens z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-punctuation z-section z-parens z-begin z-shell">(</span> <span class="z-meta z-group z-arithmetic z-shell"><span class="z-punctuation z-section z-arithmetic z-begin z-shell">((</span> off <span class="z-keyword z-operator z-assignment z-shell">=</span> <span class="z-constant z-numeric z-integer z-other z-shell"><span class="z-punctuation z-definition z-numeric z-base z-shell">16#</span>02000000</span> <span class="z-keyword z-operator z-arithmetic z-shell">+</span> <span class="z-constant z-numeric z-integer z-decimal z-shell">16</span>#<span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">IMAGE_BASE</span></span> <span class="z-punctuation z-section z-arithmetic z-end z-shell">))</span></span><span class="z-meta z-function-call z-shell"></span><span class="z-keyword z-operator z-logical z-continue z-shell">;</span> <span class="z-meta z-function-call z-shell"><span class="z-support z-function z-printf z-shell">printf</span></span><span class="z-meta z-function-call z-arguments z-shell"> 0x<span class="z-meta z-group z-expansion z-job z-shell"><span class="z-punctuation z-definition z-variable z-job z-shell">%</span><span class="z-variable z-other z-readwrite z-shell">x</span></span> <span class="z-meta z-group z-expansion z-parameter z-shell"><span class="z-punctuation z-definition z-variable z-shell">$</span><span class="z-variable z-other z-readwrite z-shell">off</span></span> </span><span class="z-punctuation z-section z-parens z-end z-shell">)</span></span> <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell">    --</span>set-section-flags</span> .linux=code,readonly <span class="z-punctuation z-separator z-continuation z-line z-shell">\
</span></span></span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-arguments z-shell">    uki_base.efi bootx64.efi</span>
</span></code></pre><h1 id=test-with-qemu><a class=zola-anchor href=#test-with-qemu aria-label="Anchor link for: test-with-qemu">Test with Qemu</a></h1><p>Create a directory and file <code>efi/boot/bootx64.efi</code><sup class=footnote-reference id=fr-3-1><a href=#fn-3>3</a></sup>, then run Qemu:<pre data-lang=bash class="language-bash z-code"><code class=language-bash data-lang=bash><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">mkdir</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>p</span> efi/boot</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">cp</span></span><span class="z-meta z-function-call z-arguments z-shell"> bootx64.efi efi/boot/</span>
</span><span class="z-source z-shell z-bash"><span class="z-meta z-function-call z-shell"><span class="z-variable z-function z-shell">qemu-system-x86_64</span></span><span class="z-meta z-function-call z-arguments z-shell"><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>m</span> 512M<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>enable-kvm</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>nographic</span><span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>bios</span> /usr/share/ovmf/OVMF.fd<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>cpu</span> host<span class="z-variable z-parameter z-option z-shell"><span class="z-punctuation z-definition z-parameter z-shell"> -</span>drive</span> file=fat:rw:./,format=raw</span>
</span></code></pre><iframe loading=lazy width=656 height=443 class=center frameborder=0 type=text/svg+xml src=/posts/uki/uki.term.svg data-display-frame=600></iframe><h1 id=conclusion><a class=zola-anchor href=#conclusion aria-label="Anchor link for: conclusion">Conclusion</a></h1><p>We created a single UKI file that contains a kernel, initramfs, cmdline, and metadata. It is easy to distribute and boot with any UEFI-compatible BIOS of the same architecture. We can imagine giving the UKI to U-Boot or iPXE to boot it in even more environments.<p>Next time, we will see how to sign the UKI so it works with secure boot.<section class=footnotes><ol class=footnotes-list><li id=fn-1><p>Found this usage of curl + xmllint <a rel=noopener target=_blank href=https://www.joshmcarthur.com/til/2018/06/19/extracting-xml-data-with-curl-and-xmllint.html>here</a> <a href=#fr-1-1>â†©</a><li id=fn-2><p>More sections can be found in <a rel=noopener target=_blank href=https://www.freedesktop.org/software/systemd/man/latest/ukify.html#%5BUKI%5D%20section>ukify manpage</a>. <a href=#fr-2-1>â†©</a><li id=fn-3><p>A FAT partition with a file <code>efi/boot/bootx64.efi</code> will be booted automatically by most UEFI implementations. The file suffix depends on the target CPU architecture. <a href=#fr-3-1>â†©</a></ol></section></section></article></main></div><footer><hr><nav style=float:right><a rel=me href=/about>Hugues</a> |
<a rel=atom href=/atom.xml class="rss icon"></a><a rel=me href=https://github.com/izissise class="github icon" style=border-bottom:none></a><a rel=me href=https://stackoverflow.com/users/2838914/izissise class="stack icon" style=border-bottom:none></a><a rel=me href=https://links.izissise.net/ class="shaarli icon" style=border-bottom:none></a><a rel=me href=https://www.linkedin.com/in/huguesmorisset/ class="linkedin icon" style=border-bottom:none></a><a rel=me href="=MWM2IDZ1cDN0ATMwEDMyEjYxEmM5QDMwIWNmFjYxQDMkFDNyYDNxATMygDNwEDOwEWM3MjM1QDM" class="m-protected matrix icon" style=border-bottom:none></a><a rel=me href="==wYwQWMiBjZ0QDMhJjM1QDM2AjMzIWM0ADZxQjM2QTMwYGN2ADZwITMiFTYyEDN2AzYwgDN3ATNxQDMhJjM1QDM" class="m-protected mail icon" style=border-bottom:none></a>| &#169; 2025